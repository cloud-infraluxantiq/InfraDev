name: CI/CD - Deploy Luxantiq Infra # testing to comment it 

on:
  workflow_dispatch:  # âœ… Enables manual trigger via GitHub Actions UI

permissions:
  contents: read
  id-token: write  # Needed for Workload Identity Federation

jobs:
  deploy:
    name: Infra + App Deploy
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: cloud-infra-dev
      REGION: asia-south1
      DJANGO_IMAGE: asia-south1-docker.pkg.dev/cloud-infra-dev/backend/djangoapi:latest
      ANGULAR_IMAGE: asia-south1-docker.pkg.dev/cloud-infra-dev/frontend/angularfrontend:latest

    steps:
    - name: â¬‡ï¸ Checkout Source Code
      uses: actions/checkout@v4

    - name: ğŸ” Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}

    - name: â˜ï¸ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: ğŸ³ Build Django Image
      run: docker build -t $DJANGO_IMAGE ./backend

    - name: ğŸ³ Build Angular Image
      run: docker build -t $ANGULAR_IMAGE ./frontend

    - name: ğŸ“¦ Push Docker Images to Artifact Registry
      run: |
        gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet
        docker push $DJANGO_IMAGE
        docker push $ANGULAR_IMAGE

    - name: ğŸš€ Deploy Django to Cloud Run (secured with Firebase)
      run: |
        gcloud run deploy DjangoAPI \
          --project=$PROJECT_ID \
          --region=$REGION \
          --platform=managed \
          --image=$DJANGO_IMAGE \
          --no-allow-unauthenticated \
          --set-env-vars=FIREBASE_AUTH=true \
          --quiet

    - name: ğŸš€ Deploy Angular to Cloud Run (public)
      run: |
        gcloud run deploy AngularFrontend \
          --project=$PROJECT_ID \
          --region=$REGION \
          --platform=managed \
          --image=$ANGULAR_IMAGE \
          --allow-unauthenticated \
          --quiet

    - name: ğŸ› ï¸ Setup Terraform CLI
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.4.6

    - name: ğŸ”„ Terraform Init + Apply (Terraform Cloud)
      working-directory: InfraDev
      run: |
        terraform init
        terraform plan
        terraform apply -auto-approve
