name: CI/CD - Deploy Luxantiq Infra
on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Infra + App Deploy
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: cloud-infra-dev
      REGION: asia-south1
      DJANGO_IMAGE: asia-south1-docker.pkg.dev/cloud-infra-dev/backend/djangoapi:latest
      ANGULAR_IMAGE: asia-south1-docker.pkg.dev/cloud-infra-dev/frontend/angularfrontend:latest
      TF_WORKSPACE: InfraDev
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

    steps:
      - name: ‚¨áÔ∏è Checkout Source Code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: üê≥ Build Django Image
        run: docker build -t $DJANGO_IMAGE ./modules/cloud_run_django

      - name: üê≥ Build Angular Image
        run: docker build -t $ANGULAR_IMAGE ./modules/cloud_run_angular

      - name: üì¶ Push Django & Angular Images to Artifact Registry
        run: |
          gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet
          docker push $DJANGO_IMAGE
          docker push $ANGULAR_IMAGE

      - name: üöÄ Deploy Django to Cloud Run (secured with Firebase)
        run: |
          gcloud run deploy django-api \
            --project=$PROJECT_ID \
            --region=$REGION \
            --platform=managed \
            --image=$DJANGO_IMAGE \
            --no-allow-unauthenticated \
            --set-env-vars=FIREBASE_AUTH=true \
            --quiet

      - name: üöÄ Deploy Angular to Cloud Run (public)
        run: |
          gcloud run deploy angular-frontend \
            --project=$PROJECT_ID \
            --region=$REGION \
            --platform=managed \
            --image=$ANGULAR_IMAGE \
            --allow-unauthenticated \
            --quiet

      - name: üõ†Ô∏è Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.4.6

      - name: üîÑ Terraform Init + Apply (Terraform Cloud)
        working-directory: ./InfraDev  # or ./ if tf files are at root
        env:
           TF_WORKSPACE: InfraDev
           TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
       run: |
           terraform init
           #terraform workspace select "$TF_WORKSPACE" || terraform workspace new "$TF_WORKSPACE"
           terraform plan
           terraform apply -auto-approve






